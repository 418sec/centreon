#!/bin/bash
###################################################################
# Centreon is developped with GPL Licence 2.0 
#
# GPL License: http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt
#
# Developped by : Julien Mathis - Romain Le Merlus 
# Contribute	: Guillaume Watteeux - Maximilien Bersoult
#
###################################################################
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
#    For information : infos@oreon-project.org
####################################################################
# redefine install command
# username : user proprietary of folder
# group : group proprietary of folder
# mode : set permission mode on file (as in chmod), ex:755
# dirmode : set permission mode on folder, ex:766

## TODO LIST
# add function to copy and rename directory


## Init default variables
username=""
group=""
mode=""
dirmode=""
backupdir=0
file=""

while getopts ":u:g:m:d:bp:" Option ; do
	echo "Option: $Option, arg: $OPTARG"
	case $Option in
		u )	username="${OPTARG}" ;;
		g )	group="${OPTARG}" ;;
		m )	mode="${OPTARG}" ;;
		d )	dirmode="${OPTARG}" ;;
		p )	basedir="${OPTARG}" ;;
		b )	backupdir=1 ;;
		* )	;;
	esac 
done
shift $(($OPTIND - 1))

echo "arg: $@"
[ -z "$username" ] && exit 1
[ ${#mode} -eq 0 -a ${#dirmode} -eq 0 ] &&  exit 1

if [ $# -eq 1 ] ; then
	[ ! -d $1 ] && mkdir -p $1
	chown -R $username:$group $1
	find `dirname $1` -type d -print | \
		xargs -I '{}' chmod $dirmode '{}'
elif [ $# -eq 2 ] ; then
	[ $backupdir -eq 1 ] && {
		[ -d $2 ] && mv $2 $2.`date +%Y%m%d-%H%M%S` 
		}
	[ ! -d `dirname $2` ] && mkdir -p `dirname $2`
	#echo "copy $1 dans $2"
	cp -r $1 $2
	if [ -n "$basedir" ] ; then 
		cd $basedir
		files=`mktemp -t cinstall_files.XXXXXX`
		directory=`mktemp -t cinstall_dirs.XXXXXX`
		find . -type f -print > $files
		find . -type d -print | grep -v "^\.$" > $directory
		
		cd $2
		cat $files $directory | xargs -I '{}' chown $username:$group '{}' 
		cat $files | xargs -I '{}' chmod $mode '{}' 
		cat $directory | xargs -I '{}' chmod $dirmode '{}' 

		rm -f $files $directory
	else 
		chown -R $username:$group $2
		if [ -f $2 ] ; then 
			echo "$2 est un fichier"
			chmod $mode $2
		else 
			find $2 -type f -print | \
				xargs -I '{}' chmod $mode '{}' 
		fi
		[ -n "$dirmode" ] && {
			find $2 -type d -print | \
				xargs -I '{}' chmod $dirmode '{}' 
				}
	fi

else 
	exit 1
fi
exit 0



