====================================
Gestion des traps SNMP avec Centreon
====================================

*************************************
Recevoir des traps SNMP avec Centreon
*************************************

Ce sous-chapitre présente les différentes étapes afin de pouvoir superviser un équipement en utilisant les traps SNMP.

Importation des traps SNMP
==========================

Afin d'importer les traps SNMP, vous devez respecter les étapes suivantes :

#. Créez un constructeur lié à la trap SNMP que vous avez créé. Voir :ref:`ce sous-chapitre <configuration_advanced_snmptrapds_manufacturer>`
#. Importez la MIB au sein de l'interface web de Centreon. Voir :ref:`ce sous-chapitre <configuration_advanced_snmptrapds_mibimport>`

Lors de l'importation d'une MIB, est possible que vous ayez besoin d'importer des dépendances au niveau de votre serveur. Afin de pouvoir trouver les dépendances de vos MIB. Il faut ouvrir votre fichier de MIB, puis :

#. Répérez la ligne qui commence par IMPORTS
#. Toutes les dépendances nécessaires à l'importation de votre fichier de MIB, se situent après le mot clé **FROM**

Exemple :

.. image :: /images/guide_exploitation/kdependances.png
   :align: center 

Dans le fichier de MIB montré ci-dessus, il existe 4 dépendances nécessaires à l'importation de la MIB : SNMPv2-SMI, SNMPv2-TC, SNMPv2-CONF, SNMP-FRAMEWORK-MIB.
Une fois l'importation terminée, il est nécessaire de modifier la définition de la trap afin de modifier le statut par défaut de la trap :

#. Rendez-vous dans **Configuration** ==> **Traps SNMP**
#. Cliquez sur la trap que vous souhaitez modifier.

En fonction du message associé à la trap, modifiez le statut par défaut du service. Dans le cas où le statut du service dépend du message reçu, utilisez le mode de correspondance avancé.

Créer un modèle de service passif
=================================

Afin de faciliter la configuration des services utilisant les traps SNMP, il est plus pratique de créer un modèle de service passif. De cette manière, lors de la création d'un service il ne restera plus qu'à faire hériter le service à partir de ce modèle et d'associer la trap ou les traps SNMP associée à ce service.

#. Rendez-vous dans **Configuration** ==> **Services**
#. Dans le menu de gauche, cliquez sur **Modèles**
#. Cliquez sur **Ajouter**

Le tableau ci-dessous résume l'ensemble des attributs d'un modèle de service passif :

+--------------------------------------+----------------------------------------------+
| Attributs                            | Description                                  | 
+======================================+==============================================+
| Onglet **Configuration du service**                                                 |
+--------------------------------------+----------------------------------------------+
| Alias                                | TRAP	                                      |
+--------------------------------------+----------------------------------------------+
| Nom du service                       | generic-service-passif                       |
+--------------------------------------+----------------------------------------------+
| Période de contrôle                  | 24x7                                         |
+--------------------------------------+----------------------------------------------+
| Commande de vérification             | check_centreon_dummy                         |
+--------------------------------------+----------------------------------------------+
| Arguments                            | Status : 0                                   |
|                                      | Output : "Aucune trap reçue depuis 24 heures |
+--------------------------------------+----------------------------------------------+
| Nombre maximum de contrôle           | 1                                            |
+--------------------------------------+----------------------------------------------+
| Contrôles actifs activées            | Non                                          |
+--------------------------------------+----------------------------------------------+
| Contrôles passifs activées           | Oui                                          |
+--------------------------------------+----------------------------------------------+
| Onglet **Traitement des données**                                                   |
+--------------------------------------+----------------------------------------------+
| Contrôler la fraîcheur du résultat   | TRAP	                                      |
+--------------------------------------+----------------------------------------------+
| Seuil de fraicheur du résultat       | 86400 (24 heures)                            |
+--------------------------------------+----------------------------------------------+

Notez bien que check_centreon_dummy sera appelé si aucune trap n'est reçue sous 24 heures.

Création du service
===================

Puis, créez le service et associez le au modèle de service passif.
Il ne vous reste plus qu'à vous rendre dans l'onglet **Relations** et de renseigner au sein du champ **Traps SNMP** les traps SNMP qui seront concernées par ce service.

Maintenant, :ref:`regénérez les fichiers de configuration <configuration_advanced_snmptrapds_generate_configuration>`.

Simuler l'envoi d'une trap
==========================

Afin de tester que la réception des traps SNMP fonctionne correctement sur votre équipement. Vous pouvez envoyez une trap SNMP fictive à votre serveur de supervision en utilisant l'utilitaire snmptrap.

Syntaxe : snmptrap -v2c -c [NOM DE COMMUNAUTÉ] [ADRESSE IP du serveur de supervision] '' [OID] [Message à afficher]

*****************************
Modifier le message de sortie
*****************************

Utiliser l'ensemble des arguments
=================================

Pour une trap SNMP, lors de la configuration du message de sortie, l'argument $* permet d'afficher l'ensemble des informations contenu au sein de la trap SNMP. Cependant, il est possible d'afficher uniquement certaines informations contenues au sein de la trap SNMP en utilisant des arguments.

Exemple : 

.. image :: /images/guide_exploitation/klinkexample.png
   :align: center

Le message de sortie "Link down on interface $2. State: $4." permet d'afficher uniquement le nom de l'interface et l'état de celle-ci

Où trouver les arguments ?

Les arguments se trouvent au sein de la documentation de la MIB de votre constructeur ou bien au sein du champ **Commentaires** de votre trap SNMP.

Par exemple :

.. image :: /images/guide_exploitation/klinkcomment.png
   :align: center

Pour afficher :

* L'index du lien tombé, utilisez l'argument $1
* Le nom de l'interface tombée, utilisez l'argument $2
* L'état administratif de l'interface, utilisez l'argument $3
* L'état de l'interface, utilisez l'argument $4

Par exemple, le message de sortie : "Link down on interface: $2 (index: $1). Operational state: $4, Administration state: $3" permet d'afficher l'ensemble des arguments au sein du message.

Utiliser l'ensemble des arguments (via les OID)
===============================================

Il est également possible d'utiliser les OID au lieu d'utiliser le caractère dollar ($).
Pour cela, utilisez la racine de l'OID et ajoutez-y l'ID de l'argument.

Par exemple, pour l'OID [...] utilisez le message de sortie suivant :
"Link down on interface: @{.1.3.6.1.6.3.1.1.5.3.2} (index: @{.1.3.6.1.6.3.1.1.5.3.1}). Operational state: @{.1.3.6.1.6.3.1.1.5.3.4}, Administration state: @{.1.3.6.1.6.3.1.1.5.3.3}"

Utiliser une variable externe
=============================

Avant d'afficher le message de sortie, il est également possible de récupérer des informations via des scripts pour pouvoir les insérer au sein du message.
Pour cela, au sein de la définition de votre trap SNMP, rendez-vous dans l'onglet **Avancé** et ajoutez une (ou plusieurs commandes PREEXEC).

Exemple :

.. image :: /images/guide_exploitation/kpreexec.png
   :align: center

La première commande est "snmpget -v 2c -Ovq -c public @HOSTADDRESS@ ifAlias.$1" et permet de récupérer l'alias de l'interface
La seconde commande contient "snmpget -v 2c -Ovq -c public @HOSTADDRESS@ ifSpeed.$1" et permet de récupérer la vitesse de l'interface.

Pour utiliser le résultat de la première commande dans le message de sortie, utilisez l'argument $p1 et pour utiliser le résultat de la seconde commande dans le message de sortie, utilisez l'argument $p2.

Par conséquent, nous pouvons déduire le message de sortie suivant : "Link down on interface: $2 (index: $1). Operational state: $4, Administration state: $3, Alias : $p1, Speed : $p2".

********************************
Router/transférer les traps SNMP
********************************

Parfois, il existe un concentrateur de trap SNMP au sein d'une société. Exemple : Oracle GRID.
Oracle GRID est chargé de fédérer les informations de tous les serveurs Oracle, en cas de nécessité c'est le serveur Oracle GRID qui envoit une trap SNMP au serveur de supervision.

Or, à partir d'une trap SNMP reçue par Oracle GRID, on souhaite pouvoir extraire l'adresse IP de l'hôte concerné et afficher le message de la trap dans un service appartenant non pas à Oracle Grid mais à l'hôte concerné par la trap.

Pour cela, exécutez la procédure suivante :

1. Créez une trap générique, ayant les paramètres suivants : 

+--------------------------------------+----------------------------------------------+
| Attributs                            | Description                                  | 
+======================================+==============================================+
| Onglet **Configuration de la trap**                                                 |
+--------------------------------------+----------------------------------------------+
| Nom                                  | Nom de la trap	                              |
+--------------------------------------+----------------------------------------------+
| OID                                  | OID de la trap                               |
+--------------------------------------+----------------------------------------------+
| Statut                               | Statut par défaut de la trap                 |
+--------------------------------------+----------------------------------------------+
| Message de sortie                    | Message de sortie personnalisé               |
+--------------------------------------+----------------------------------------------+
| Onglet **Avancé**                                                                   |
+--------------------------------------+----------------------------------------------+
| Activé le routage                    | Cochez la case	                              |
+--------------------------------------+----------------------------------------------+
| Seuil de fraicheur du résultat       | $2 (ici on part du principe que l'argument   |
|                                      | numéro 2 de la trap contient l'adresse IP    |
|                                      | de l'hôte concerné par la trap)              |
+--------------------------------------+----------------------------------------------+

2. Créer une deuxième définition de trap avec :

+--------------------------------------+------------------------------------------------------------+
| Attributs                            | Description                                                | 
+======================================+============================================================+
| Onglet **Configuration de la trap**                                                               |
+--------------------------------------+------------------------------------------------------------+
| Nom                                  | Nom de la trap	(autre que celui de la première définition) |
+--------------------------------------+------------------------------------------------------------+
| OID                                  | OID de la trap (même que celui de la première définition)  |
+--------------------------------------+------------------------------------------------------------+
| Statut                               | Statut par défaut de la trap                               |
+--------------------------------------+------------------------------------------------------------+
| Message de sortie                    | Message de sortie personnalisé                             |
+--------------------------------------+------------------------------------------------------------+

3. Associer la première définition à un service (par exemple PING) du serveur Oracle GRID

4. Associer la deuxième définition à un service passif de l'hôte concerné

5. Générer les définition de traps SNMP et redémarrer centreontrapd

Notez bien que au sein du champ **Commande de routage** vous pouvez utiliser les arguments suivants : 

+----------------------+-------------------------------------------------------------------------------------------------------------+
|   Nom de la variable |   Description                                                                                               |
+======================+=============================================================================================================+
| @GETHOSTBYADDR($2)@  | Résolution DNS inverse permettant de connaitre le nom DNS à partir de l'adresse IP (127.0.0.1 -> localhost) |
+----------------------+-------------------------------------------------------------------------------------------------------------+
| @GETHOSTBYNAME($2)@  | Résolution DNS permettant de connaitre l'adresse IP à partir du nom DNS (localhost -> 127.0.0.1)            |
+----------------------+-------------------------------------------------------------------------------------------------------------+

***
FAQ
***

Comme vu dans le chapitre :ref:`traps SNMP <configuration_advanced_snmptrapds>`, plusieurs éléments entrent en jeu dans la gestion des traps SNMP. En cas de problèmes, il est nécessaire de vérifier le bon fonctionnement de son architecture, plusieurs points sont à vérifier :

* Vérifier que le service snmptrapd appelle bien centreontrapdforward. Pour cela, éditez le fichier **/etc/snmp/snmptrapd.conf** et vérifiez que le fichier contient :

::

    traphandle default su -l centreon -c "/usr/share/centreon/bin/centreontrapdforward"
    
* Suite à l'importation de vos traps SNMP en base de données, avez-vous bien :ref:`regénéré les fichiers de configuration <configuration_advanced_snmptrapds_generate_configuration>` ?
* Vos paramètres de connexion à la base de données sont-ils corrects ? Voir le fichier **/etc/centreon/conf.pm**